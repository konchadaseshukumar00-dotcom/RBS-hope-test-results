<!DOCTYPE html>
<html>
<head>
<title>Results</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{background:#0b5394;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.box{background:white;width:900px;margin:30px auto;padding:20px;border-radius:10px;box-shadow:0 0 12px #999;text-align:center;}
.bar{background:#cfe2f3;padding:12px;margin:8px;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.adminOnly{display:none;}
input{padding:6px;margin:5px;}
button{background:#990000;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;}
.smallbtn{background:#0b5394;margin-left:5px;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Results</h2>
 <button onclick="history.back()">â¬… Back</button>
</div>

<div class="box">

<!-- Admin Panel -->
<div id="adminPanel" class="adminOnly">
 <h3>Create / Edit Test</h3>
 <input id="testName" placeholder="Test Name">
 <input id="subjects" placeholder="Subject:PassMark, Subject:PassMark">
 <button onclick="loadStudents()">Load Students</button>
 <div id="marksBox"></div>
 <hr>
</div>

<!-- Test Bars -->
<div id="testBars"></div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= ADMIN CHECK ================= */
let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) adminPanel.style.display="block";

/* ================= LOAD STUDENTS ================= */
let tenthStudents=[];
db.ref("students/10").once("value",snap=>{
 tenthStudents = Object.values(snap.val() || {});
});

/* ================= PARSE SUBJECTS ================= */
function parseSubjects(){
 let raw = subjects.value.split(",").map(s=>s.trim()).filter(s=>s);
 let subNames=[], passMarks=[];
 raw.forEach(item=>{
   let parts = item.split(":");
   subNames.push(parts[0].trim());
   passMarks.push(Number(parts[1]));
 });
 return {subNames, passMarks};
}

/* ================= LOAD STUDENTS FOR MARK ENTRY ================= */
function loadStudents(){
 let {subNames} = parseSubjects();
 if(subNames.length===0){ alert("Enter subjects correctly"); return; }

 let html="<h4>Enter Marks</h4>";
 tenthStudents.forEach((stu,i)=>{
   html+=`<b>${stu.name} (${stu.roll})</b><br>`;
   subNames.forEach((sub,j)=>{
     html+=`${sub}: <input id="m${i}_${j}" size="4"><br>`;
   });
   html+="<hr>";
 });
 html+=`<button onclick="saveTest()">Save Test</button>`;
 marksBox.innerHTML = html;
}

/* ================= SAVE TEST ================= */
function saveTest(){
 let {subNames, passMarks} = parseSubjects();

 let obj={
   testName: testName.value,
   subjects: subNames,
   passMarks: passMarks,
   results:[]
 };

 tenthStudents.forEach((stu,i)=>{
   let marks=[];
   subNames.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value || 0));
   });
   obj.results.push({roll:stu.roll, name:st
