<!DOCTYPE html>
<html>
<head>
<title>Results</title>
<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{
 background:#0b5394;color:white;padding:15px;
 display:flex;justify-content:space-between;align-items:center;
}
.box{
 background:white;width:900px;margin:30px auto;
 padding:20px;border-radius:10px;box-shadow:0 0 12px #999;
 text-align:center;
}
.bar{
 background:#cfe2f3;
 padding:12px;
 margin:8px;
 border-radius:6px;
 cursor:pointer;
 display:flex;
 justify-content:space-between;
 align-items:center;
}
.adminOnly{display:none;}
input{padding:6px;margin:5px;}
button{
 background:#990000;color:white;
 border:none;padding:6px 12px;
 border-radius:5px;cursor:pointer;
}
.smallbtn{
 background:#0b5394;
 margin-left:5px;
}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Results</h2>
 <button onclick="history.back()">‚¨Ö Back</button>
</div>

<div class="box">

<div id="adminPanel" class="adminOnly">
 <h3>Create New Test (10th Class)</h3>
 <input id="testName" placeholder="Test Name">
 <input id="subjects" placeholder="Subjects (comma separated)">
 <button onclick="loadStudents()">Load Students</button>
 <div id="marksBox"></div>
 <hr>
</div>

<div id="testBars"></div>

</div>

<script>
let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) adminPanel.style.display="block";

let studentsData = JSON.parse(localStorage.getItem("studentsData"))||{};
let tenthStudents = studentsData["10"] || [];
let tests = JSON.parse(localStorage.getItem("savedTests"))||[];

function showBars(){
 testBars.innerHTML="<h3>Available Tests</h3>";

 if(tests.length===0){
   testBars.innerHTML+="<p>No Results Available</p>";
   return;
 }

 tests.forEach((t,i)=>{
   testBars.innerHTML+=`
    <div class="bar">
      <span onclick="openStudentResult(${i})">${t.testName}</span>
      ${isAdmin?`
        <span>
          <button class="smallbtn" onclick="downloadTestPDF(${i})">üìÑ PDF</button>
          <button class="smallbtn" onclick="editTest(${i})">‚úèÔ∏è</button>
          <button onclick="deleteTest(${i})">‚ùå</button>
        </span>`:""}
    </div>`;
 });
}
showBars();

function loadStudents(){
 if(tenthStudents.length===0){
   marksBox.innerHTML="<p>No 10th Class Students Found</p>";
   return;
 }

 let subs = subjects.value.split(",").map(s=>s.trim());
 let html="<h4>Enter Marks</h4>";

 tenthStudents.forEach((s,i)=>{
   html+=`<b>${s.name} (${s.roll})</b><br>`;
   subs.forEach((sub,j)=>{
     html+=`${sub}: <input id="m${i}_${j}" size="4"><br>`;
   });
   html+="<hr>";
 });

 html+=`<button onclick="saveTest()">Save Test</button>`;
 marksBox.innerHTML=html;
}

function saveTest(){
 let subs = subjects.value.split(",").map(s=>s.trim());
 let obj = {testName:testName.value,subjects:subs,results:[]};

 tenthStudents.forEach((s,i)=>{
   let marks=[];
   subs.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value||0));
   });
   obj.results.push({roll:s.roll,name:s.name,marks});
 });

 tests.push(obj);
 localStorage.setItem("savedTests",JSON.stringify(tests));
 alert("Test Saved");
 marksBox.innerHTML="";
 testName.value="";
 subjects.value="";
 showBars();
}

function editTest(index){
 let newName = prompt("Edit Test Name:", tests[index].testName);
 if(newName){
   tests[index].testName = newName;
   localStorage.setItem("savedTests",JSON.stringify(tests));
   showBars();
 }
}

function deleteTest(index){
 if(confirm("Are you sure you want to delete this test?")){
   tests.splice(index,1);
   localStorage.setItem("savedTests",JSON.stringify(tests));
   showBars();
 }
}

function openStudentResult(i){
 localStorage.setItem("selectedTestIndex",i);
 location.href="studentresult.html";
}

/* ===== PDF DOWNLOAD FUNCTION ===== */
function downloadTestPDF(index){
 let t = tests[index];

 let html = `
 <h2 style="text-align:center;">RBS INSTITUTIONS</h2>
 <h3 style="text-align:center;">${t.testName} - Marks Report</h3>
 <hr>
 <table border="1" style="border-collapse:collapse;width:100%;text-align:center;">
 <tr>
   <th>S.No</th>
   <th>Roll No</th>
   <th>Name</th>`;

 t.subjects.forEach(sub=>{
   html += `<th>${sub}</th>`;
 });

 html += `<th>Total</th></tr>`;

 t.results.forEach((r,i)=>{
   let total = r.marks.reduce((a,b)=>a+b,0);
   html += `<tr>
     <td>${i+1}</td>
     <td>${r.roll}</td>
     <td>${r.name}</td>`;
   r.marks.forEach(m=>{
     html += `<td>${m}</td>`;
   });
   html += `<td>${total}</td></tr>`;
 });

 html += "</table>";

 let w = window.open("");
 w.document.write(html);
 w.print();
 w.close();
}
</script>

</body>
</html>
