<!DOCTYPE html>
<html>
<head>
<title>Results</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{background:#0b5394;color:white;padding:15px;display:flex;justify-content:space-between}
.box{background:white;width:900px;margin:30px auto;padding:20px;border-radius:10px;box-shadow:0 0 12px #999}
.bar{background:#cfe2f3;padding:12px;margin:8px;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between}
.adminOnly{display:none}
button{background:#990000;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer}
.smallbtn{background:#0b5394;margin-left:5px}
input,select{padding:6px;margin:5px}
</style>
</head>

<body>

<div class="header">
<h2>RBS Institutions - Results</h2>
<button onclick="history.back()">‚¨Ö Back</button>
</div>

<div class="box">

<div id="adminPanel" class="adminOnly">
<h3>Create / Edit Test</h3>

<input id="testName" placeholder="Test Name">
<input id="subjects" placeholder="Subject:PassMark, Subject:PassMark">
<br>
<label>Result Release Time:</label>
<input type="datetime-local" id="resultTime">

<br><br>
<button onclick="loadStudents()">Load Students</button>
<div id="marksBox"></div>
<hr>

<select id="testSelect">
<option value="">-- Select Test for Progress Report --</option>
</select>
<button onclick="downloadAllProgressReports()">üìÑ Download Progress Report</button>
</div>

<div id="testBars"></div>
</div>

<script>
/* Firebase */
firebase.initializeApp({
 apiKey:"AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 databaseURL:"https://rbs-institutions-portal-default-rtdb.firebaseio.com"
});
const db=firebase.database();

/* Admin */
let isAdmin=localStorage.getItem("isAdmin")==="true";
if(isAdmin) adminPanel.style.display="block";

/* Students */
let tenthStudents=[], studentsLoaded=false;
db.ref("students/10").once("value",s=>{
 tenthStudents=Object.values(s.val()||{});
 studentsLoaded=true;
});

/* Globals */
let editingKey=null;

/* Helpers */
function parseSubjects(){
 let arr=subjects.value.split(",").map(s=>s.trim()).filter(Boolean);
 return {
  subNames:arr.map(x=>x.split(":")[0]),
  passMarks:arr.map(x=>Number(x.split(":")[1]))
 };
}

/* Load Students */
function loadStudents(){
 editingKey=null;
 let {subNames}=parseSubjects();
 if(!subNames.length) return alert("Enter subjects");

 let html="<h4>Enter Marks</h4>";
 tenthStudents.forEach((s,i)=>{
  html+=`<b>${s.name} (${s.roll})</b><br>`;
  subNames.forEach((_,j)=>{
   html+=`<input id="m${i}_${j}" size="4"><br>`;
  });
  html+="<hr>";
 });
 html+=`<button onclick="saveTest()">Save Test</button>`;
 marksBox.innerHTML=html;
}

/* Save */
function saveTest(){
 let {subNames,passMarks}=parseSubjects();
 let obj={
  testName:testName.value,
  subjects:subNames,
  passMarks,
  releaseTime:new Date(resultTime.value).getTime(),
  results:[]
 };

 tenthStudents.forEach((s,i)=>{
  let marks=[];
  subNames.forEach((_,j)=>marks.push(+document.getElementById(`m${i}_${j}`).value||0));
  obj.results.push({roll:s.roll,name:s.name,marks});
 });

 db.ref("tests").push(obj);
 alert("Saved");
 marksBox.innerHTML="";
 showBars();
}

/* Edit */
function editTest(key){
 if(!studentsLoaded) return alert("Loading students");
 editingKey=key;

 db.ref("tests/"+key).once("value",snap=>{
  let t=snap.val();
  testName.value=t.testName;
  subjects.value=t.subjects.map((s,i)=>`${s}:${t.passMarks[i]}`).join(", ");
  resultTime.value=new Date(t.releaseTime).toISOString().slice(0,16);

  let html="<h4>Edit Marks</h4>";
  tenthStudents.forEach((stu,i)=>{
   let res=t.results.find(r=>String(r.roll)===String(stu.roll));
   html+=`<b>${stu.name} (${stu.roll})</b><br>`;
   t.subjects.forEach((_,j)=>{
    html+=`<input id="m${i}_${j}" value="${res?res.marks[j]:""}" size="4"><br>`;
   });
   html+="<hr>";
  });
  html+=`<button onclick="updateTest()">Update Test</button>`;
  marksBox.innerHTML=html;
 });
}

/* Update */
function updateTest(){
 let {subNames,passMarks}=parseSubjects();
 let obj={
  testName:testName.value,
  subjects:subNames,
  passMarks,
  releaseTime:new Date(resultTime.value).getTime(),
  results:[]
 };

 tenthStudents.forEach((s,i)=>{
  let marks=[];
  subNames.forEach((_,j)=>marks.push(+document.getElementById(`m${i}_${j}`).value||0));
  obj.results.push({roll:s.roll,name:s.name,marks});
 });

 db.ref("tests/"+editingKey).set(obj);
 alert("Updated");
 marksBox.innerHTML="";
 editingKey=null;
 showBars();
}

/* Delete */
function deleteTest(key){
 if(confirm("Delete test?")){
  db.ref("tests/"+key).remove();
  showBars();
 }
}

/* List */
function showBars(){
 testBars.innerHTML="<h3>Available Tests</h3>";
 testSelect.innerHTML='<option value="">-- Select Test --</option>';

 db.ref("tests").once("value",s=>{
  let d=s.val(); if(!d) return;
  Object.keys(d).forEach(k=>{
   let t=d[k];
   testBars.innerHTML+=`
   <div class="bar" onclick="openStudentResult('${k}')">
    <span>${t.testName}</span>
    ${isAdmin?`
    <span>
     <button class="smallbtn" onclick="event.stopPropagation();editTest('${k}')">‚úè</button>
     <button class="smallbtn" onclick="event.stopPropagation();downloadTestPDF('${k}')">üìÑ</button>
     <button onclick="event.stopPropagation();deleteTest('${k}')">‚ùå</button>
    </span>`:""}
   </div>`;
   testSelect.innerHTML+=`<option value="${k}">${t.testName}</option>`;
  });
 });
}
showBars();

/* Student Page */
function openStudentResult(key){
 localStorage.setItem("selectedTestKey",key);
 location.href="services.html";
}

/* Test PDF */
function downloadTestPDF(key){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF("l","mm","a4");
 db.ref("tests/"+key).once("value",s=>{
  let t=s.val(),y=35;
  doc.text("RBS INSTITUTIONS",148,15,{align:"center"});
  t.results.forEach((r,i)=>{
   doc.text(`${i+1}. ${r.roll} ${r.name} Total:${r.marks.reduce((a,b)=>a+b)}`,20,y);
   y+=8; if(y>190){doc.addPage();y=20;}
  });
  doc.save(t.testName+".pdf");
 });
}

/* Progress Report */
async function downloadAllProgressReports(){
 let k=testSelect.value;
 if(!k) return alert("Select test");
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 let t=(await db.ref("tests/"+k).once("value")).val();
 t.results.forEach((r,i)=>{
  doc.text(`${r.name} (${r.roll})`,20,20);
  doc.addPage();
 });
 doc.save("ProgressReports.pdf");
}
</script>
</body>
</html>
