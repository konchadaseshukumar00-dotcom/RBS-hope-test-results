<!DOCTYPE html>
<html>
<head>
<title>Results</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{
 background:#0b5394;color:white;padding:15px;
 display:flex;justify-content:space-between;align-items:center;
}
.box{
 background:white;width:900px;margin:30px auto;
 padding:20px;border-radius:10px;
 box-shadow:0 0 12px #999;
 text-align:center;
}
.bar{
 background:#cfe2f3;
 padding:12px;margin:8px;border-radius:6px;
 cursor:pointer;
 display:flex;justify-content:space-between;align-items:center;
}
.adminOnly{display:none;}
input{padding:6px;margin:5px;}
button{
 background:#990000;color:white;
 border:none;padding:6px 12px;
 border-radius:5px;cursor:pointer;
}
.smallbtn{background:#0b5394;margin-left:5px;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Results</h2>
 <button onclick="history.back()">‚¨Ö Back</button>
</div>

<div class="box">

<!-- Admin Panel -->
<div id="adminPanel" class="adminOnly">
 <h3>Create New Test (10th Class)</h3>
 <input id="testName" placeholder="Test Name">
 <input id="subjects" placeholder="Subjects (comma separated)">
 <button onclick="loadStudents()">Load Students</button>
 <div id="marksBox"></div>
 <hr>
</div>

<!-- Test Bars -->
<div id="testBars"></div>

</div>

<script>
/* ======================
   FIREBASE CONFIG
====================== */
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ======================
   ADMIN CHECK
====================== */
let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) document.getElementById("adminPanel").style.display="block";

/* ======================
   LOAD STUDENTS
====================== */
let tenthStudents = [];
db.ref("students/10").once("value",snap=>{
 let data = snap.val() || {};
 tenthStudents = Object.values(data);
});

/* ======================
   SHOW TEST BARS
====================== */
function showBars(){
 testBars.innerHTML="<h3>Available Tests</h3>";

 db.ref("tests").once("value", snap=>{
   let data = snap.val();
   if(!data){
     testBars.innerHTML+="<p>No Results Available</p>";
     return;
   }

   Object.keys(data).forEach(key=>{
     let t = data[key];
     testBars.innerHTML += `
      <div class="bar" onclick="openStudentResult('${key}')">
        <span>${t.testName}</span>
        ${isAdmin?`
        <span>
         <button class="smallbtn"
           onclick="event.stopPropagation();downloadTestPDF('${key}')">üìÑ PDF</button>
         <button onclick="event.stopPropagation();deleteTest('${key}')">‚ùå</button>
        </span>`:""}
      </div>`;
   });
 });
}
showBars();

/* ======================
   LOAD STUDENTS FOR MARK ENTRY
====================== */
function loadStudents(){
 if(tenthStudents.length===0){
   marksBox.innerHTML="<p>No Students Found</p>";
   return;
 }

 let subs = subjects.value.split(",").map(s=>s.trim()).filter(s=>s);
 if(subs.length===0){ alert("Enter Subjects!"); return; }

 let html="<h4>Enter Marks</h4>";
 tenthStudents.forEach((s,i)=>{
   html+=`<b>${s.name} (${s.roll})</b><br>`;
   subs.forEach((sub,j)=>{
     html+=`${sub}: <input id="m${i}_${j}" size="4"><br>`;
   });
   html+="<hr>";
 });
 html+=`<button onclick="saveTest()">Save Test</button>`;
 marksBox.innerHTML=html;
}

/* ======================
   SAVE TEST
====================== */
function saveTest(){
 let subs = subjects.value.split(",").map(s=>s.trim());
 let obj = { testName:testName.value, subjects:subs, results:[] };

 tenthStudents.forEach((s,i)=>{
   let marks=[];
   subs.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value || 0));
   });
   obj.results.push({roll:s.roll,name:s.name,marks});
 });

 db.ref("tests").push(obj);
 alert("Test Saved!");
 marksBox.innerHTML="";
 testName.value="";
 subjects.value="";
 showBars();
}

/* ======================
   DELETE TEST
====================== */
function deleteTest(key){
 if(confirm("Delete this test?")){
   db.ref("tests/"+key).remove();
   showBars();
 }
}

/* ======================
   OPEN RESULT PAGE
====================== */
function openStudentResult(key){
 localStorage.setItem("selectedTestKey",key);
 location.href="services.html";
}

/* ======================
   PERFECT PDF DOWNLOAD
====================== */
async function downloadTestPDF(key){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF("p","mm","a4");

 db.ref("tests/"+key).once("value",snap=>{
   let t = snap.val();

   // ===== Header =====
   doc.setFontSize(18);
   doc.text("RBS INSTITUTIONS",105,15,{align:"center"});
   doc.setFontSize(14);
   doc.text(t.testName+" - Marks Report",105,23,{align:"center"});
   doc.line(10,27,200,27);

   // ===== Column Positions =====
   let startY = 35;
   let rowHeight = 8;

   let cols = [
     {title:"S.No", x:10},
     {title:"Roll No", x:25},
     {title:"Name", x:55}
   ];

   let xPos = 55;
   t.subjects.forEach(sub=>{
     xPos += 20;
     cols.push({title:sub, x:xPos});
   });

   cols.push({title:"Total", x:xPos+20});
   cols.push({title:"Result", x:xPos+40});

   // ===== Draw Header Row =====
   doc.setFontSize(10);
   cols.forEach(c=>{
     doc.text(c.title, c.x, startY);
   });

   let y = startY + rowHeight;

   // ===== Draw Data Rows =====
   t.results.forEach((r,i)=>{
     let total = r.marks.reduce((a,b)=>a+b,0);
     let result = total >= 35 ? "PASS" : "FAIL";

     let row = [
       i+1,
       r.roll,
       r.name,
       ...r.marks,
       total,
       result
     ];

     row.forEach((cell,index)=>{
       doc.text(String(cell), cols[index].x, y);
     });

     y += rowHeight;

     // New Page if needed
     if(y > 280){
       doc.addPage();
       y = 20;
     }
   });

   // ===== Save File =====
   doc.save(t.testName+"_Results.pdf");
 });
}
</script>

</body>
</html>
