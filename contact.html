 <!DOCTYPE html>
<html>
<head>
<title>Results</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{
 background:#0b5394;color:white;padding:15px;
 display:flex;justify-content:space-between;align-items:center;
}
.box{
 background:white;width:900px;margin:30px auto;padding:20px;
 border-radius:10px;box-shadow:0 0 12px #999;text-align:center;
}
.bar{
 background:#cfe2f3;padding:12px;margin:8px;border-radius:6px;
 cursor:pointer;display:flex;justify-content:space-between;align-items:center;
}
.locked{opacity:.6;cursor:not-allowed;}
.adminOnly{display:none;}
input,select{padding:6px;margin:5px;}
button{
 background:#990000;color:white;border:none;
 padding:6px 12px;border-radius:5px;cursor:pointer;
}
.smallbtn{background:#0b5394;margin-left:5px;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Results</h2>
 <button onclick="history.back()">‚¨Ö Back</button>
</div>

<div class="box">

<!-- ADMIN PANEL -->
<div id="adminPanel" class="adminOnly">
 <h3>Create / Edit Test</h3>

 <input id="testName" placeholder="Test Name">
 <input id="subjects" placeholder="Subject:PassMark, Subject:PassMark">
 <br>
 <label><b>Result Open Time:</b></label>
 <input type="datetime-local" id="resultTime">
 <br>

 <button onclick="loadStudents()">Load Students</button>

 <br><br>

 <select id="testSelect">
   <option value="">-- Select Test for Progress Report --</option>
 </select>

 <button onclick="downloadAllProgressReports()">
 üìÑ Download Progress Report (All Students)
 </button>

 <div id="marksBox"></div>
 <hr>
</div>

<!-- TEST LIST -->
<div id="testBars"></div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= ADMIN CHECK ================= */
let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) adminPanel.style.display="block";

/* ================= LOAD STUDENTS ================= */
let tenthStudents=[];
db.ref("students/10").once("value",snap=>{
 tenthStudents = Object.values(snap.val() || {});
});

/* ================= SUBJECT PARSE ================= */
function parseSubjects(){
 let raw=subjects.value.split(",").map(s=>s.trim()).filter(s=>s);
 let subNames=[], passMarks=[];
 raw.forEach(r=>{
   let p=r.split(":");
   subNames.push(p[0]);
   passMarks.push(Number(p[1]));
 });
 return {subNames,passMarks};
}

/* ================= LOAD MARK ENTRY ================= */
function loadStudents(){
 let {subNames}=parseSubjects();
 if(!subNames.length){alert("Enter subjects");return;}

 let html="<h4>Enter Marks</h4>";
 tenthStudents.forEach((stu,i)=>{
   html+=`<b>${stu.name} (${stu.roll})</b><br>`;
   subNames.forEach((s,j)=>{
     html+=`${s}: <input id="m${i}_${j}" size="4"><br>`;
   });
   html+="<hr>";
 });
 html+=`<button onclick="saveTest()">Save Test</button>`;
 marksBox.innerHTML=html;
}

/* ================= SAVE TEST ================= */
function saveTest(){
 let {subNames,passMarks}=parseSubjects();
 if(!resultTime.value){alert("Set result open time");return;}

 let obj={
   testName:testName.value,
   subjects:subNames,
   passMarks,
   releaseTime:new Date(resultTime.value).getTime(),
   results:[]
 };

 tenthStudents.forEach((stu,i)=>{
   let marks=[];
   subNames.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value||0));
   });
   obj.results.push({roll:stu.roll,name:stu.name,marks});
 });

 db.ref("tests").push(obj);
 alert("Test Saved");
 marksBox.innerHTML="";
 showBars();
}

/* ================= SHOW TEST LIST ================= */
function showBars(){
 let box=testBars, select=testSelect;
 box.innerHTML="<h3>Available Tests</h3>";
 select.innerHTML='<option value="">-- Select Test --</option>';

 db.ref("tests").once("value",snap=>{
   let data=snap.val();
   if(!data){box.innerHTML+="No Tests";return;}

   Object.keys(data).forEach(key=>{
     let t=data[key];
     let locked=!isAdmin && Date.now()<t.releaseTime;

     box.innerHTML+=`
     <div class="bar ${locked?"locked":""}"
      ${locked?"":`onclick="openStudentResult('${key}')"`}>
       <span>${t.testName}</span>
       <span>
         ${locked
           ? "‚è≥ Opens at "+new Date(t.releaseTime).toLocaleString()
           : "‚úÖ View Result"}
       </span>
       ${isAdmin?`
       <span>
        <button class="smallbtn"
         onclick="event.stopPropagation();editTest('${key}')">‚úè Edit</button>
        <button class="smallbtn"
         onclick="event.stopPropagation();downloadTestPDF('${key}')">üìÑ PDF</button>
        <button
         onclick="event.stopPropagation();deleteTest('${key}')">‚ùå</button>
       </span>`:""}
     </div>`;

     select.innerHTML+=`<option value="${key}">${t.testName}</option>`;
   });
 });
}
showBars();

/* ================= EDIT TEST ================= */
function editTest(key){
 db.ref("tests/"+key).once("value",snap=>{
   let t=snap.val();
   testName.value=t.testName;
   subjects.value=t.subjects.map((s,i)=>`${s}:${t.passMarks[i]}`).join(",");
   resultTime.value=new Date(t.releaseTime).toISOString().slice(0,16);

   let html="<h4>Edit Marks</h4>";
   tenthStudents.forEach((stu,i)=>{
     html+=`<b>${stu.name} (${stu.roll})</b><br>`;
     t.subjects.forEach((s,j)=>{
       let old=t.results.find(r=>r.roll==stu.roll)?.marks[j]||0;
       html+=`${s}: <input id="m${i}_${j}" value="${old}" size="4"><br>`;
     });
     html+="<hr>";
   });
   html+=`<button onclick="updateTest('${key}')">Update Test</button>`;
   marksBox.innerHTML=html;
 });
}

/* ================= UPDATE TEST ================= */
function updateTest(key){
 let {subNames,passMarks}=parseSubjects();

 let obj={
   testName:testName.value,
   subjects:subNames,
   passMarks,
   releaseTime:new Date(resultTime.value).getTime(),
   results:[]
 };

 tenthStudents.forEach((stu,i)=>{
   let marks=[];
   subNames.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value||0));
   });
   obj.results.push({roll:stu.roll,name:stu.name,marks});
 });

 db.ref("tests/"+key).set(obj);
 alert("Test Updated");
 marksBox.innerHTML="";
 showBars();
}

/* ================= DELETE ================= */
function deleteTest(key){
 if(confirm("Delete Test?")){
   db.ref("tests/"+key).remove();
   showBars();
 }
}

/* ================= OPEN RESULT ================= */
function openStudentResult(key){
 localStorage.setItem("selectedTestKey",key);
 location.href="services.html";
}
</script>

</body>
</html>
