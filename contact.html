<!DOCTYPE html>
<html>
<head>
<title>Results</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{
 background:#0b5394;color:white;padding:15px;
 display:flex;justify-content:space-between;align-items:center;
}
.box{
 background:white;width:900px;margin:30px auto;padding:20px;
 border-radius:10px;box-shadow:0 0 12px #999;text-align:center;
}
.bar{
 background:#cfe2f3;padding:12px;margin:8px;border-radius:6px;
 display:flex;justify-content:space-between;align-items:center;
}
.locked{opacity:.6;cursor:not-allowed;}
.adminOnly{display:none;}
input,select{padding:6px;margin:5px;}
button{
 background:#990000;color:white;border:none;
 padding:6px 12px;border-radius:5px;cursor:pointer;
}
.smallbtn{background:#0b5394;margin-left:5px;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Results</h2>
 <button onclick="history.back()">‚¨Ö Back</button>
</div>

<div class="box">

<!-- ADMIN PANEL -->
<div id="adminPanel" class="adminOnly">
 <h3>Create / Edit Test</h3>

 <input id="testName" placeholder="Test Name">
 <input id="subjects" placeholder="Subject:PassMark, Subject:PassMark">
 <br>
 <label><b>Result Open Time:</b></label>
 <input type="datetime-local" id="resultTime">
 <br>

 <button onclick="loadStudents()">Load Students</button>

 <br><br>

 <select id="testSelect">
   <option value="">-- Select Test for Progress Report --</option>
 </select>

 <button onclick="downloadAllProgressReports()">
 üìÑ Download Progress Report (All Students)
 </button>

 <div id="marksBox"></div>
 <hr>
</div>

<!-- TEST LIST -->
<div id="testBars"></div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= GLOBAL STATE ================= */
let isAdmin = localStorage.getItem("isAdmin")==="true";
let tenthStudents = [];
let studentsLoaded = false;
let editingTestKey = null;

if(isAdmin) adminPanel.style.display="block";

/* ================= LOAD STUDENTS ================= */
db.ref("students/10").once("value",snap=>{
 tenthStudents = Object.values(snap.val() || {});
 studentsLoaded = true;
});

/* ================= SUBJECT PARSE ================= */
function parseSubjects(){
 let raw=subjects.value.split(",").map(s=>s.trim()).filter(s=>s);
 let subNames=[], passMarks=[];
 raw.forEach(r=>{
   let p=r.split(":");
   subNames.push(p[0]);
   passMarks.push(Number(p[1]));
 });
 return {subNames,passMarks};
}

/* ================= LOAD MARK ENTRY ================= */
function loadStudents(){
 if(!studentsLoaded){ alert("Students loading, wait"); return; }

 let {subNames}=parseSubjects();
 if(!subNames.length){alert("Enter subjects");return;}

 editingTestKey = null; // CREATE MODE

 let html="<h4>Enter Marks</h4>";
 tenthStudents.forEach((stu,i)=>{
   html+=`<b>${stu.name} (${stu.roll})</b><br>`;
   subNames.forEach((s,j)=>{
     html+=`${s}: <input id="m${i}_${j}" size="4"><br>`;
   });
   html+="<hr>";
 });
 html+=`<button onclick="saveTest()">Save Test</button>`;
 marksBox.innerHTML=html;
}

/* ================= SAVE TEST ================= */
function saveTest(){
 let {subNames,passMarks}=parseSubjects();
 if(!resultTime.value){alert("Set result open time");return;}

 let obj={
   testName:testName.value,
   subjects:subNames,
   passMarks,
   releaseTime:new Date(resultTime.value).getTime(),
   results:[]
 };

 tenthStudents.forEach((stu,i)=>{
   let marks=[];
   subNames.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value||0));
   });
   obj.results.push({roll:stu.roll,name:stu.name,marks});
 });

 db.ref("tests").push(obj);
 alert("Test Saved");
 marksBox.innerHTML="";
 showBars();
}

/* ================= SHOW TEST LIST ================= */
function showBars(){
 testBars.innerHTML="<h3>Available Tests</h3>";
 testSelect.innerHTML='<option value="">-- Select Test --</option>';

 db.ref("tests").once("value",snap=>{
   let data=snap.val();
   if(!data){testBars.innerHTML+="No Tests";return;}

   Object.keys(data).forEach(key=>{
     let t=data[key];
     let locked=!isAdmin && Date.now()<t.releaseTime;

     testBars.innerHTML+=`
     <div class="bar ${locked && !isAdmin ? "locked":""}"
      ${(!locked || isAdmin)?`onclick="openStudentResult('${key}')"`:""}>
       <span>${t.testName}</span>
       <span>
         ${locked ? "‚è≥ Opens at "+new Date(t.releaseTime).toLocaleString()
                  : "‚úÖ View Result"}
       </span>
       ${isAdmin?`
       <span>
        <button class="smallbtn"
         onclick="event.stopPropagation();editTest('${key}')">‚úè Edit</button>
        <button class="smallbtn"
         onclick="event.stopPropagation();downloadTestPDF('${key}')">üìÑ PDF</button>
        <button
         onclick="event.stopPropagation();deleteTest('${key}')">‚ùå</button>
       </span>`:""}
     </div>`;

     testSelect.innerHTML+=`<option value="${key}">${t.testName}</option>`;
   });
 });
}
showBars();

/* ================= EDIT TEST ================= */
function editTest(key){
 if(!studentsLoaded){alert("Students loading");return;}

 editingTestKey = key;

 db.ref("tests/"+key).once("value",snap=>{
   let t=snap.val();

   testName.value = t.testName;
   subjects.value = t.subjects.map((s,i)=>`${s}:${t.passMarks[i]}`).join(", ");
   resultTime.value = new Date(t.releaseTime).toISOString().slice(0,16);

   let html="<h4>Edit Marks</h4>";

   tenthStudents.forEach((stu,i)=>{
     let res=t.results.find(r=>String(r.roll)===String(stu.roll));
     html+=`<b>${stu.name} (${stu.roll})</b><br>`;

     t.subjects.forEach((s,j)=>{
       let val=res?res.marks[j]:0;
       html+=`${s}: <input id="m${i}_${j}" value="${val}" size="4"><br>`;
     });
     html+="<hr>";
   });

   html+=`<button onclick="updateTest()">Update Test</button>`;
   marksBox.innerHTML=html;
 });
}

/* ================= UPDATE TEST ================= */
function updateTest(){
 let {subNames,passMarks}=parseSubjects();

 let obj={
   testName:testName.value,
   subjects:subNames,
   passMarks,
   releaseTime:new Date(resultTime.value).getTime(),
   results:[]
 };

 tenthStudents.forEach((stu,i)=>{
   let marks=[];
   subNames.forEach((_,j)=>{
     marks.push(Number(document.getElementById(`m${i}_${j}`).value||0));
   });
   obj.results.push({roll:stu.roll,name:stu.name,marks});
 });

 db.ref("tests/"+editingTestKey).set(obj);
 alert("Test Updated");
 editingTestKey=null;
 marksBox.innerHTML="";
 showBars();
}

/* ================= DELETE ================= */
function deleteTest(key){
 if(confirm("Delete Test?")){
   db.ref("tests/"+key).remove();
   showBars();
 }
}

/* ================= OPEN RESULT ================= */
function openStudentResult(key){
 localStorage.setItem("selectedTestKey",key);
 location.href="services.html";
}

/* ================= FULL TEST MARKS PDF ================= */
async function downloadTestPDF(key){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF("l","mm","a4");

 db.ref("tests/"+key).once("value",snap=>{
   let t=snap.val();

   doc.setFontSize(18);
   doc.text("RBS INSTITUTIONS",148,15,{align:"center"});
   doc.setFontSize(14);
   doc.text(t.testName+" - Marks Report",148,23,{align:"center"});
   doc.line(10,28,285,28);

   let headers=["S.No","Roll","Name",...t.subjects,"Total","Result"];
   let startX=10,startY=35,rowH=8;
   doc.setFontSize(9);

   function drawRow(row,y){
     let x=startX;
     row.forEach(cell=>{
       doc.rect(x,y,20,rowH);
       doc.text(String(cell),x+2,y+5);
       x+=20;
     });
   }

   drawRow(headers,startY);
   let y=startY+rowH;

   t.results.forEach((r,i)=>{
     let total=r.marks.reduce((a,b)=>a+b,0);
     let pass=true;
     r.marks.forEach((m,j)=>{if(m<t.passMarks[j]) pass=false;});
     drawRow([i+1,r.roll,r.name,...r.marks,total,pass?"PASS":"FAIL"],y);
     y+=rowH;
     if(y>190){doc.addPage();y=20;}
   });

   doc.save(t.testName+"_Results.pdf");
 });
}

/* ================= PROGRESS REPORT ALL STUDENTS ================= */
async function downloadAllProgressReports(){
 let testKey=testSelect.value;
 if(!testKey){alert("Select test");return;}

 const {jsPDF}=window.jspdf;
 const doc=new jsPDF("p","mm","a4");

 let test= (await db.ref("tests/"+testKey).once("value")).val();
 let students=Object.values((await db.ref("students/10").once("value")).val()||{});
 students.sort((a,b)=>a.roll.localeCompare(b.roll));

 let top=true;
 students.forEach(stu=>{
   let res=test.results.find(r=>String(r.roll)===String(stu.roll));
   if(!res) return;

   if(!top) doc.addPage();
   top=false;

   let y=15;
   doc.setFontSize(14);
   doc.text("RBS INSTITUTIONS",105,y,{align:"center"}); y+=8;
   doc.text(test.testName+" - Progress Report",105,y,{align:"center"}); y+=10;

   doc.setFontSize(11);
   doc.text("Name: "+stu.name,20,y);
   doc.text("Roll: "+stu.roll,140,y); y+=8;

   res.marks.forEach((m,i)=>{
     doc.text(test.subjects[i],20,y);
     doc.text(String(m),90,y);
     doc.text(m>=test.passMarks[i]?"PASS":"FAIL",140,y);
     y+=6;
   });
 });

 doc.save("All_Progress_Reports.pdf");
}
</script>

</body>
</html>
