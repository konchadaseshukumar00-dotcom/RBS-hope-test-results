<!DOCTYPE html>
<html>
<head>
<title>Results</title>
<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{background:#0b5394;color:white;padding:15px;}
.box{
 background:white;width:900px;margin:30px auto;
 padding:20px;border-radius:10px;box-shadow:0 0 12px #999;
 text-align:center;
}
.bar{background:#cfe2f3;padding:10px;margin:8px;border-radius:6px;cursor:pointer;}
.adminOnly{display:none;}
input{padding:5px;margin:5px;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Results</h2>
</div>

<div class="box">

<div id="adminPanel" class="adminOnly">
 <h3>Create New Test (10th Class)</h3>
 <input id="testName" placeholder="Test Name">
 <input id="subjects" placeholder="Subjects comma separated">
 <button onclick="loadStudents()">Load Students</button>
 <div id="marksBox"></div>
</div>

<div id="testBars"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 storageBucket: "rbs-institutions-portal.firebasestorage.app",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) adminPanel.style.display="block";

const studentsRef = ref(db,"students/10");
const testsRef = ref(db,"tests");

window.loadStudents = function(){
 onValue(studentsRef,(snap)=>{
  let students = snap.val()||{};
  let subs = subjects.value.split(",").map(s=>s.trim());
  let html="<h4>Enter Marks</h4>";

  Object.values(students).forEach((s,i)=>{
    html+=`<b>${s.name} (${s.roll})</b><br>`;
    subs.forEach((sub,j)=>{
      html+=`${sub}: <input id="m${i}_${j}" size="4"><br>`;
    });
    html+="<hr>";
  });

  html+=`<button onclick="saveTest()">Save Test</button>`;
  marksBox.innerHTML=html;
 });
}

window.saveTest = function(){
 let subs = subjects.value.split(",").map(s=>s.trim());
 let obj={testName:testName.value,subjects:subs,results:[]};

 onValue(studentsRef,(snap)=>{
  let students = snap.val()||{};
  Object.values(students).forEach((s,i)=>{
    let marks=[];
    subs.forEach((_,j)=>{
      marks.push(Number(document.getElementById(`m${i}_${j}`).value||0));
    });
    obj.results.push({roll:s.roll,name:s.name,marks});
  });
  push(testsRef,obj);
  alert("Test Saved");
 });
}

// Show available tests
onValue(testsRef,(snap)=>{
 let data=snap.val()||{};
 testBars.innerHTML="<h3>Available Tests</h3>";
 Object.values(data).forEach((t,i)=>{
  testBars.innerHTML+=`<div class="bar" onclick="openResult(${i})">${t.testName}</div>`;
 });
});

window.openResult = function(i){
 localStorage.setItem("testIndex",i);
 location.href="studentresult.html";
}
</script>

</body>
</html>
