<!DOCTYPE html>
<html>
<head>
<title>Student Result</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{background:#0b5394;color:white;padding:15px;}
.box{
 background:white;width:700px;margin:30px auto;padding:20px;
 border-radius:10px;box-shadow:0 0 12px #999;text-align:center;
}
table{border-collapse:collapse;width:100%;margin-top:10px;}
td,th{border:1px solid #333;padding:6px;}
.pass{color:green;font-weight:bold;}
.fail{color:red;font-weight:bold;}

img{
 border:1px solid #333;
 max-width:150px;
 height:auto;
 image-rendering:auto;
}

button{
 background:#990000;color:white;border:none;
 padding:6px 12px;border-radius:5px;cursor:pointer;
 margin-top:10px;
}
</style>
</head>
<body>

<div class="header">
 <h2>RBS Institutions - Student Result</h2>
</div>

<div class="box">

<h3>Enter Roll Number</h3>
<input id="roll" placeholder="Roll Number">
<button onclick="getResult()">Get Result</button>

<div id="output"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const studentsRef = ref(db,"students/10");

/* ================= GET RESULT ================= */
window.getResult = async function(){

 let rollNo = document.getElementById("roll").value.trim();
 let output = document.getElementById("output");

 if(!rollNo){
   output.innerHTML="<p class='fail'>Enter Roll Number</p>";
   return;
 }

 let testKey = localStorage.getItem("selectedTestKey");
 if(!testKey){
   output.innerHTML="<p class='fail'>No test selected</p>";
   return;
 }

 // Load test
 let testSnap = await get(ref(db,"tests/"+testKey));
 let test = testSnap.val();
 if(!test){
   output.innerHTML="<p class='fail'>Test not found</p>";
   return;
 }

 // Load students
 let stuSnap = await get(studentsRef);
 let students = Object.values(stuSnap.val() || {});
 let student = students.find(s=>s.roll==rollNo);

 if(!student){
   output.innerHTML="<p class='fail'>Roll Number Not Found</p>";
   return;
 }

 // Find result
 let resultRow = test.results.find(r=>r.roll==rollNo);
 if(!resultRow){
   output.innerHTML="<p class='fail'>Result not available</p>";
   return;
 }

 let total = 0;
 let finalResult = "PASS";
 let rowsHTML = "";

 resultRow.marks.forEach((m,i)=>{
   let status = m >= test.passMarks[i] ? "PASS" : "FAIL";
   if(status==="FAIL") finalResult="FAIL";
   total += Number(m);

   rowsHTML += `
   <tr>
     <td>${test.subjects[i]}</td>
     <td>${m}</td>
     <td class="${status==="PASS"?"pass":"fail"}">${status}</td>
   </tr>`;
 });

 // Store data for PDF
 window.currentStudentData = { student, test, resultRow, total, finalResult };

 output.innerHTML = `
 <h3>${test.testName}</h3>

 <table>
  <tr>
   <td rowspan="3">
     ${student.photo ? `<img src="${student.photo}">` : ""}
   </td>
   <td><b>Name:</b> ${student.name}</td>
  </tr>
  <tr><td><b>Roll No:</b> ${student.roll}</td></tr>
 </table>

 <table>
  <tr>
   <th>Subject</th>
   <th>Marks</th>
   <th>Status</th>
  </tr>
  ${rowsHTML}
 </table>

 <h3>Total: ${total}</h3>
 <h3 class="${finalResult==="PASS"?"pass":"fail"}">
   FINAL RESULT: ${finalResult}
 </h3>

 <button onclick="downloadPDF()">ðŸ“„ Download Result PDF</button>
 `;
}

/* ================= REAL PDF DOWNLOAD ================= */
window.downloadPDF = function(){

 const { jsPDF } = window.jspdf;
 const doc = new jsPDF("p","mm","a4");

 let { student, test, resultRow, total, finalResult } = window.currentStudentData;

 let y = 20;
 doc.setFontSize(16);
 doc.text("RBS INSTITUTIONS",105,y,{align:"center"}); 
 y+=10;
 doc.text(test.testName+" - Student Result",105,y,{align:"center"});
 y+=15;

 doc.setFontSize(12);
 doc.text("Name: "+student.name,20,y); y+=8;
 doc.text("Roll No: "+student.roll,20,y); y+=12;

 doc.text("Subject",20,y);
 doc.text("Marks",100,y);
 doc.text("Status",150,y);
 y+=5;
 doc.line(20,y,190,y);
 y+=8;

 resultRow.marks.forEach((m,i)=>{
   let status = m >= test.passMarks[i] ? "PASS":"FAIL";
   doc.text(test.subjects[i],20,y);
   doc.text(String(m),100,y);
   doc.text(status,150,y);
   y+=8;
 });

 y+=5;
 doc.text("Total: "+total,20,y);
 y+=10;
 doc.setFontSize(13);
 doc.text("FINAL RESULT: "+finalResult,20,y);
 y+=20;

 doc.setFontSize(11);
 doc.text("Teacher Signature",20,y);
 doc.text("Parent Signature",140,y);

 doc.save(student.roll+"_Result.pdf");
}
</script>

</body>
</html>
