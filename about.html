<!DOCTYPE html>
<html>
<head>
<title>Student Details</title>
<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{background:#0b5394;color:white;padding:15px;text-align:center;}
.box{
 background:white;width:900px;margin:30px auto;
 padding:20px;border-radius:10px;box-shadow:0 0 12px #999;
 text-align:center;
}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.bar{background:#cfe2f3;padding:10px;border-radius:6px;cursor:pointer;}
table{width:90%;margin:auto;border-collapse:collapse;}
th,td{border:1px solid #999;padding:6px;}
th{background:#0b5394;color:white;}
.adminOnly{display:none;}
button{padding:6px 10px;margin:5px;cursor:pointer;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS INSTITUTIONS</h2>
 <h3>Student Details</h3>
</div>

<div class="box">
<h3>Class Wise Students</h3>

<div id="allBar" class="bar adminOnly" onclick="showAll()">üìã All Students</div>
<br><br>

<div class="grid" id="classBars"></div>
<div id="list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// üîπ Firebase Config
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 storageBucket: "rbs-institutions-portal.firebasestorage.app",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) document.querySelectorAll(".adminOnly").forEach(e=>e.style.display="block");

// Create class buttons
for(let i=1;i<=10;i++){
 classBars.innerHTML+=`<div class="bar" onclick="showClass(${i})">${i} Class</div>`;
}

// ---------- CLASS WISE ----------
window.showClass = function(cls){
 const classRef = ref(db, "students/"+cls);
 onValue(classRef, (snap)=>{
   let data = snap.val() || {};
   let keys = Object.keys(data);
   let html=`<h3>${cls} Class Students</h3>`;

   // Admin PDF Button
   if(isAdmin){
     html+=`<button onclick="downloadClassPDF(${cls})">üìÑ Download Class PDF</button><br><br>`;
   }

   if(keys.length==0){
     html+="<p>No students</p>";
   } else {
     html+=`<table id="classTable">
       <tr>
         <th>S.No</th>
         <th>Name</th>
         <th>Roll No</th>
         ${isAdmin?"<th>Action</th>":""}
       </tr>`;

     keys.forEach((k,i)=>{
       let s=data[k];
       html+=`<tr>
         <td>${i+1}</td>
         <td>${s.name}</td>
         <td>${s.roll}</td>
         ${isAdmin?`<td><button onclick="delStudent('${cls}','${k}')">‚ùå</button></td>`:""}
       </tr>`;
     });
     html+="</table>";
   }

   // Add Student
   if(isAdmin){
     html+=`<br>
       <input id="n" placeholder="Name">
       <input id="r" placeholder="Roll No">
       <button onclick="addStudent(${cls})">Add</button>`;
   }

   list.innerHTML=html;
 });
}

// Add Student
window.addStudent = function(cls){
 let name=document.getElementById("n").value;
 let roll=document.getElementById("r").value;
 if(name && roll){
   push(ref(db,"students/"+cls),{name,roll});
 }
}

// Delete Student
window.delStudent = function(cls,key){
 remove(ref(db,"students/"+cls+"/"+key));
}


// ---------- ALL STUDENTS ----------
window.showAll = function(){
 const allRef = ref(db,"students");
 onValue(allRef,(snap)=>{
   let data = snap.val() || {};
   let html="<h3>All Students</h3>";

   // Admin PDF Button
   if(isAdmin){
     html+=`<button onclick="downloadAllPDF()">üìÑ Download All Students PDF</button><br><br>`;
   }

   html+=`<table id="allTable">
     <tr>
       <th>Class</th>
       <th>S.No</th>
       <th>Name</th>
       <th>Roll No</th>
     </tr>`;

   for(let c in data){
     let arr = Object.values(data[c]);
     arr.forEach((s,i)=>{
       html+=`<tr>
         <td>${c}</td>
         <td>${i+1}</td>
         <td>${s.name}</td>
         <td>${s.roll}</td>
       </tr>`;
     });
   }

   html+="</table>";
   list.innerHTML=html;
 });
}


// ---------- PDF FUNCTIONS ----------
window.downloadClassPDF = function(cls){
 let table = document.getElementById("classTable").outerHTML;
 let w = window.open("");
 w.document.write(`
   <h2 style="text-align:center;">RBS INSTITUTIONS</h2>
   <h3 style="text-align:center;">${cls} Class Students</h3>
   <hr>
   ${table}
 `);
 w.print();
 w.close();
}

window.downloadAllPDF = function(){
 let table = document.getElementById("allTable").outerHTML;
 let w = window.open("");
 w.document.write(`
   <h2 style="text-align:center;">RBS INSTITUTIONS</h2>
   <h3 style="text-align:center;">All Students</h3>
   <hr>
   ${table}
 `);
 w.print();
 w.close();
}

</script>

</body>
</html>
