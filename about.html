<!DOCTYPE html>
<html>
<head>
<title>Student Details</title>
<style>
body{font-family:Arial;background:#eef2f3;margin:0;}
.header{background:#0b5394;color:white;padding:15px;text-align:center;}
.box{
 background:white;width:950px;margin:30px auto;
 padding:20px;border-radius:10px;box-shadow:0 0 12px #999;
 text-align:center;
}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.bar{background:#cfe2f3;padding:10px;border-radius:6px;cursor:pointer;}
table{width:95%;margin:auto;border-collapse:collapse;}
th,td{border:1px solid #999;padding:6px;}
th{background:#0b5394;color:white;}
.adminOnly{display:none;}
button{padding:5px 10px;margin:3px;}
img{width:40px;height:50px;object-fit:cover;}
</style>
</head>
<body>

<div class="header">
 <h2>RBS INSTITUTIONS</h2>
 <h3>Student Details</h3>
</div>

<div class="box">
<h3>Class Wise Students</h3>

<div id="allBar" class="bar adminOnly" onclick="showAll()">üìã All Students</div>
<br><br>

<div class="grid" id="classBars"></div>
<div id="list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, update }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* üîπ Firebase Config */
const firebaseConfig = {
 apiKey: "AIzaSyDGMYTX20mKna9VGddgi6mCIyJkCgbJ7bA",
 authDomain: "rbs-institutions-portal.firebaseapp.com",
 databaseURL: "https://rbs-institutions-portal-default-rtdb.firebaseio.com",
 projectId: "rbs-institutions-portal",
 messagingSenderId: "881467222162",
 appId: "1:881467222162:web:7acd765c4f7490ea6b9e4b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Admin Check */
let isAdmin = localStorage.getItem("isAdmin")==="true";
if(isAdmin) document.querySelectorAll(".adminOnly").forEach(e=>e.style.display="block");

/* Create class buttons */
for(let i=1;i<=10;i++){
 classBars.innerHTML+=`<div class="bar" onclick="showClass(${i})">${i} Class</div>`;
}

/* Resize image to passport size */
function readImage(file){
 return new Promise(resolve=>{
   const reader = new FileReader();
   reader.onload = function(e){
     const img = new Image();
     img.onload = function(){
       const canvas = document.createElement("canvas");
       canvas.width = 40;
       canvas.height = 50;
       canvas.getContext("2d").drawImage(img,0,0,40,50);
       resolve(canvas.toDataURL("image/jpeg",0.9));
     }
     img.src = e.target.result;
   }
   reader.readAsDataURL(file);
 });
}

/* ======================
   SHOW CLASS WISE
====================== */
window.showClass = function(cls){
 const classRef = ref(db,"students/"+cls);
 onValue(classRef,(snap)=>{
   let data = snap.val()||{};
   let keys = Object.keys(data);
   let html=`<h3>${cls} Class Students</h3>`;

   /* PDF Buttons */
   if(isAdmin){
     if(cls==10){
       html+=`
        <button onclick="downloadClassPDF(${cls},false)">üìÑ PDF Without Images</button>
        <button onclick="downloadClassPDF(${cls},true)">üñºÔ∏è PDF With Images</button>
        <br><br>`;
     } else {
       html+=`<button onclick="downloadClassPDF(${cls},false)">üìÑ Download Class PDF</button><br><br>`;
     }
   }

   if(keys.length==0){
     html+="<p>No students</p>";
   } else {

     html+=`<table id="classTable">
      <tr>
       <th>S.No</th>`;

     if(cls==10) html+=`<th>Photo</th>`;

     html+=`
       <th>Name</th>
       <th>Roll</th>
       ${isAdmin?"<th>Action</th>":""}
      </tr>`;

     keys.forEach((k,i)=>{
       let s=data[k];
       html+=`<tr>
        <td>${i+1}</td>`;

       if(cls==10) html+=`<td>${s.photo?`<img src="${s.photo}">`:"-"}</td>`;

       html+=`
        <td>${s.name}</td>
        <td>${s.roll}</td>
        ${isAdmin?`
         <td>
          <button onclick="editStudent('${cls}','${k}','${s.name}','${s.roll}')">‚úèÔ∏è</button>
          <button onclick="delStudent('${cls}','${k}')">‚ùå</button>
         </td>`:""}
       </tr>`;
     });
     html+="</table>";
   }

   /* Add Student */
   if(isAdmin){
     html+=`<br>
      <input id="n" placeholder="Name">
      <input id="r" placeholder="Roll No">`;

     if(cls==10){
       html+=`<input type="file" id="img" accept="image/*">`;
     }

     html+=`<button onclick="addStudent(${cls})">Add Student</button>`;
   }

   list.innerHTML=html;
 });
}

/* ======================
   ADD STUDENT
====================== */
window.addStudent = async function(cls){
 let name=n.value, roll=r.value;
 let photo="";

 if(cls==10 && img.files[0]){
   photo = await readImage(img.files[0]);
 }

 if(name && roll){
   push(ref(db,"students/"+cls),{name,roll,photo});
 }
}

/* ======================
   DELETE
====================== */
window.delStudent = function(cls,key){
 remove(ref(db,"students/"+cls+"/"+key));
}

/* ======================
   EDIT
====================== */
window.editStudent = async function(cls,key,name,roll){
 let newName = prompt("Edit Name:",name);
 let newRoll = prompt("Edit Roll:",roll);
 if(newName===null || newRoll===null) return;

 let updateData={name:newName,roll:newRoll};

 if(cls==10){
   let imgInput=document.createElement("input");
   imgInput.type="file";
   imgInput.accept="image/*";
   imgInput.click();
   imgInput.onchange = async ()=>{
     if(imgInput.files[0]){
       updateData.photo = await readImage(imgInput.files[0]);
     }
     update(ref(db,"students/"+cls+"/"+key),updateData);
   }
 } else {
   update(ref(db,"students/"+cls+"/"+key),updateData);
 }
}

/* ======================
   SHOW ALL STUDENTS
   (NO IMAGES)
====================== */
window.showAll = function(){
 const allRef = ref(db,"students");
 onValue(allRef,(snap)=>{
  let data=snap.val()||{};
  let html="<h3>All Students</h3>";

  if(isAdmin){
    html+=`<button onclick="downloadAllPDF()">üìÑ Download All Students PDF</button><br><br>`;
  }

  html+=`<table id="allTable">
   <tr>
    <th>Class</th>
    <th>S.No</th>
    <th>Name</th>
    <th>Roll</th>
   </tr>`;

  for(let c in data){
    let arr=Object.values(data[c]);
    arr.forEach((s,i)=>{
      html+=`<tr>
        <td>${c}</td>
        <td>${i+1}</td>
        <td>${s.name}</td>
        <td>${s.roll}</td>
      </tr>`;
    });
  }
  html+="</table>";
  list.innerHTML=html;
 });
}

/* ======================
   PDF FUNCTIONS
====================== */

window.downloadClassPDF = function(cls,withImg){
 let table = document.getElementById("classTable").cloneNode(true);

 /* Remove Action column */
 table.querySelectorAll("tr").forEach(row=>{
   let last = row.cells[row.cells.length-1];
   if(last && last.innerText.includes("‚úèÔ∏è")) row.deleteCell(row.cells.length-1);
 });

 /* Remove Photo column if NOT required */
 if(cls==10 && !withImg){
   table.querySelectorAll("tr").forEach(row=>{
     row.deleteCell(1);
   });
 }

 let w=window.open("");
 w.document.write(`
  <h2 style="text-align:center;">RBS INSTITUTIONS</h2>
  <h3 style="text-align:center;">${cls} Class Students</h3>
  <hr>${table.outerHTML}`);
 w.print(); 
 w.close();
}

/* All Students PDF (No Images Always) */
window.downloadAllPDF = function(){
 let table=document.getElementById("allTable").outerHTML;
 let w=window.open("");
 w.document.write(`
  <h2 style="text-align:center;">RBS INSTITUTIONS</h2>
  <h3 style="text-align:center;">All Students Details</h3>
  <hr>${table}`);
 w.print(); 
 w.close();
}
</script>

</body>
</html>
